<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Create Your Wishlist</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <link rel="stylesheet" href="/assets/all.css">

  <style>

    .deleteBtn {
      cursor: pointer;
    }
    
    
  </style>
</head>
<body>

  <nav>
    <div class="nav-wrapper">
      <a href="/" class="brand-logo">MyWishList</a>
      <a href="#" data-target="mobile-demo" class="sidenav-trigger"><i class="material-icons">menu</i></a>
      <ul class="right hide-on-med-and-down">
        <li id="signOutConditional"></li>
      </ul>
    </div>
  </nav>
  
  <ul class="sidenav" id="mobile-demo">
    <li id="signOutNav"></li>
  </ul>



  <div class="container">

  <div id="title" class="center"></div>

<div class="row center">
  Add an item, with an optional link. Once you've made your list, you can share your link with family and friends :). You can always come back and update your list :)
 
</div>



<div class="row">
  <form class="col s12">
    <div class="row">
      <div class="input-field col s12">
        <input placeholder="title" id="myDescription" type="text" class="validate">
        <label for="first_name">Title/description</label>
      </div>
      <div class="input-field col s12">
        <input id="myLink" type="text">
        <label for="link">Link</label>
      </div>
    </div>

    <a id="addItem" class="waves-effect waves-light btn-small">Add Item</a>


    <div class="collection" id="myItemsDiv"></div>
   
   
  
    <a id="shareList" class="waves-effect waves-light btn-small">Share List</a>
    <div id="shareLink"></div>

   

  </form>
</div>

</div>
  <script src="/assets/all.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  
  <script>

    document.addEventListener('DOMContentLoaded', function () {
        var elems = document.querySelectorAll('.modal');
        var instances = M.Modal.init(elems, {});
      });

  let listId = window.location.pathname.substr(window.location.pathname.length - 10);


  let newListData
  let newID

  let newestID



//we make an axios get for all of the user's lists and find the one with the matching URL. We then make an axios request for all of the items within that list to be added to the page. The trash can icon contains the dataset-id of the item, and once it's clicked it is deleted according to that id. 
   axios.get(`/api/lists/users`, {
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      }
    })
      .then(({ data }) => {
        console.log(data)

        if(data.length == 0){
          console.log('nothing')
        }


        data.forEach(list => {
          if (listId == list.randomURL) {
            newID = list.id
            newListTitle = list.title
            console.log(newID)
            newListData = list
          }
        })
        
        console.log(newID)
        document.getElementById('title').innerHTML = `<h2> ${newListTitle} </h2>`
        console.log(newListTitle)
       
      
        axios.get(`/api/items`, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        })
          .then(({ data }) => {
            console.log(data), 'items'
            
            data.forEach(item => {
              
              console.log(newID)
              if (item.lid == newID) {
                console.log('da same')
                document.getElementById('myItemsDiv').innerHTML += `
                <li  class = "collection-item"> ${item.description} <a class="truncate" target="_blank" href="${item.link}">${item.link}</a> 
                <i data-id='${item.id}' class="material-icons deleteBtn red-text">delete</i>
                </li>
                `
              }
            }
            )
          })

        })
      
      .catch(err => console.log(err))


    document.getElementById('addItem').addEventListener('click', event => {
        event.preventDefault()
        if (document.getElementById('myDescription').value == '' && document.getElementById('myLink').value == '') {
          alert('you must have either a description or a link')
          return
        }

        let item = {
          description: document.getElementById('myDescription').value,
          link: document.getElementById('myLink').value,
          isDone: false,
          lid: newListData.id
        }
        //create comment call
        axios.post('/api/items', item, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        })
          .then(({ data }) => {
            // console.log(data)
            document.getElementById('myDescription').value = ''
            document.getElementById('myLink').value = ''
            document.getElementById('myItemsDiv').innerHTML += `
          <li ${item.isDone ? 'style="background-color: #9FD356;' : ""} class = "collection-item"> ${data.description} <a class="truncate" target="_blank" href="${data.link}">${data.link}</a> </li>
          <i data-id='${data.id}' class="material-icons deleteBtn red-text">delete</i>
          `



          })
          .catch(err => console.log(err))
      })


    document.addEventListener('click', event => {

      if (event.target.classList.contains('deleteBtn')) {
             
        axios.delete(`/api/items/${event.target.dataset.id}`, {
         headers: {
         'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
            })
          .then(res => {
                   
            window.location.reload()

              })
            }
          })


  document.getElementById('shareList').addEventListener('click', event => {
      document.getElementById('shareLink').innerHTML = `
      <h5> Shareable Link: </h5>
  <h5> https://mywishlistio.herokuapp.com/list/${listId} </h5>

  `
    })


  


  



 


 




 

  </script>

</body>
</html>