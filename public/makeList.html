<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Create Your Wishlist</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <link rel="stylesheet" href="/assets/all.css">

  <style>

      body {
      font-family: Roboto, arial;
      background: black;
      color: rgb(241, 241, 241);
      }

     

    .deleteBtn {
      cursor: pointer;
    }
    
    
  </style>
</head>
<body>

  <nav>
    <div class="nav-wrapper">
      <a href="/" class="brand-logo">Wishlistable</a>
      <a href="#" data-target="mobile-demo" class="sidenav-trigger"><i class="material-icons">menu</i></a>
      <ul class="right hide-on-med-and-down">
        <li id="signOutConditional"></li>
      </ul>
    </div>
  </nav>
  
  <ul class="sidenav" id="mobile-demo">
    <li> <a style="padding-top: 10px;" href="/home">Home</a> </li>
    <br>
    <br>
    <li id="signOutNav"></li>
  </ul>



  <div class="container">

  <div id="title" class="center"></div>

<div class="row center">
  <h5>
  Add each item, with an optional link. Once you've made your list, you can share your link with family and friends :). You can always come back and update your list :)
  </h5>
 
</div>



<div class="row">
  <form class="col s12">
    <div class="row">
      <div class="input-field col s12">
        <input placeholder="" id="myDescription" type="text" class="validate white-text">
        <label for="first_name">Title/description</label>
      </div>
      <div class="input-field col s12">
        <input id="myLink" type="text" class="white-text">
        <label for="link">Link</label>
      </div>
    </div>

    <a id="addItem" class="waves-effect waves-light btn-small">Add Item</a>


    <div class="collection" style="background-color: black;" id="myItemsDiv"></div>
   
   
  
    <a href="#shareLink" id="shareList" class="waves-effect waves-light btn-small modal-trigger">Share List</a>
    <div class="modal black white-text" id="shareLink"></div>






   

  </form>
</div>

</div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"
    integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script src="/assets/all.js"></script>
  <script>

    $(document).ready(function(){
      $('.modal').modal()
    })

    document.addEventListener('DOMContentLoaded', function () {
        var elems = document.querySelectorAll('.modal');
        var instances = M.Modal.init(elems, {});
      });

  let listId = window.location.pathname.substr(window.location.pathname.length - 10);


  let newListData
  let newID

  let newestID



//we make an axios get for all of the user's lists and find the one with the matching URL. We then make an axios request for all of the items within that list to be added to the page. The trash can icon contains the dataset-id of the item, and once it's clicked it is deleted according to that id. 
   axios.get(`/api/lists/users`, {
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      }
    })
      .then(({ data }) => {
        // console.log(data)

        if(data.length == 0){
          // console.log('nothing')
        }


        data.forEach(list => {
          if (listId == list.randomURL) {
            newID = list.id
            newListTitle = list.title
            // console.log(newID)
            newListData = list
          }
        })
        
        // console.log(newID)
        document.getElementById('title').innerHTML = `<h2> ${newListTitle} </h2>`
        // console.log(newListTitle)
       
      
        axios.get(`/api/items`, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        })
          .then(({ data }) => {
            // console.log(data), 'items'
            
            data.forEach(item => {
              
              // console.log(newID)
              if (item.lid == newID) {
                // console.log('da same')
                document.getElementById('myItemsDiv').innerHTML += `
                <li  class = "collection-item black white-text"> ${item.description} <a class="truncate" target="_blank" href="${item.link}">${item.link}</a> 
                <i data-id='${item.id}' class="material-icons deleteBtn red-text">delete</i>
                </li>
                `
              }
            }
            )
          })

        })
      
      .catch(err => console.log(err))


    document.getElementById('addItem').addEventListener('click', event => {
        event.preventDefault()
        if (document.getElementById('myDescription').value == '' && document.getElementById('myLink').value == '') {
          alert('you must have either a description or a link')
          return
        }
        let linkArea = document.getElementById('myLink').value
        // console.log(linkArea)
        let subStringedLink = linkArea.substring(0, 3)

        if (subStringedLink === 'www') {
          linkArea = 'https://' + linkArea
          // console.log(subStringedLink)
        }
         else if (subStringedLink != 'htt') {
          linkArea = 'https://www.' + linkArea
        } 
        

        let item = {
          description: document.getElementById('myDescription').value,
          link: linkArea,
          isDone: false,
          lid: newListData.id
        }
        //create comment call
        axios.post('/api/items', item, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        })
          .then(({ data }) => {
            // console.log(data)
            document.getElementById('myDescription').value = ''
            document.getElementById('myLink').value = ''
            document.getElementById('myItemsDiv').innerHTML += `
          <li class ="collection-item black white-text"> ${data.description} <a class="truncate" target="_blank" href="${data.link}">${data.link}
            
            </a> 
          <i data-id='${data.id}' class="material-icons deleteBtn red-text">delete</i>
          </li>
          `
          })
          .catch(err => console.log(err))
      })


    document.addEventListener('click', event => {

      if (event.target.classList.contains('deleteBtn')) {
             
        axios.delete(`/api/items/${event.target.dataset.id}`, {
         headers: {
         'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
            })
          .then(res => {
                   
            window.location.reload()

              })
            }
          })


  document.getElementById('shareList').addEventListener('click', event => {
      document.getElementById('shareLink').innerHTML = `
      <h5> Shareable Link: </h5>
  <input class="black white-text" value="https://mywishlistio.herokuapp.com/list/${listId}" id="copyableLink"></input>
  <button class="btn-small" id="copyLink"> copy link </button>

  `
  function Copy() {
      
      let newUrl = document.getElementById('copyableLink')
      // console.log(newUrl)
      newUrl.select();
      document.execCommand("copy")
      alert('link copied! :)')
    }
    document.getElementById('copyLink').addEventListener('click', event => {
      Copy()
    })
    })


   


  


  



 


 




 

  </script>

</body>
</html>