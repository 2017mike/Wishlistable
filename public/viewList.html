<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User's Wishlist</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <link rel="stylesheet" href="/assets/all.css">

  <style>
    body {
      font-family: Roboto, arial;
      background: black;
      color: rgb(241, 241, 241);
      }


    .checkBtn {
      cursor: pointer;
    }

    .cancel {
      cursor: pointer;
    }

    .modal-trigger {
      cursor: pointer;
    }

    .hidden {
      display: none;
    }

    .myModal {
      position: fixed;
      /* Stay in place */
      z-index: 1;
      /* Sit on top */
      left: 0;
      top: 0;
      width: 100%;
      /* Full width */
      height: 100%;
      /* Full height */
      overflow: auto;
      /* Enable scroll if needed */
      background-color: rgb(0, 0, 0);
      /* Fallback color */
      background-color: rgba(0, 0, 0, 0.4);
      /* Black w/ opacity */
    }

    .modal-content {
      background-color: #fefefe;
      margin: 15% auto;
      /* 15% from the top and centered */
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      /* Could be more or less, depending on screen size */
    }

    #makeYourOwnBtn {
      padding-bottom: 20px;
      margin-bottom: 20px;
    }
  </style>
</head>

<body>


  <nav>
    <div class="nav-wrapper">
      <a href="/" class="brand-logo">Wishlistable</a>
      <a href="#" data-target="mobile-demo" class="sidenav-trigger"><i class="material-icons">menu</i></a>
      <ul class="right hide-on-med-and-down">
        <li id="signOutConditional"></li>
      </ul>
    </div>
  </nav>

  <ul class="sidenav" id="mobile-demo">
    <li> <a style="padding-top: 10px;" class="white-text" href="/home">Home</a> </li>
    <br>
    <br>
    <li id="signOutNav"></li>
  </ul>

  <div class="container">
    <div id="title" class="center"></div>
    <h5>Once you have bought an item, click the green check icon to move it into the "Already Bought" section. </h5>
    <div class="row">
      <div class="collection col s12 m6 l6" id="myItemsDiv">
        <h4>Not Yet Bought</h4>
      </div>


      <div class="collection col s12 m6 l6" id="boughtItemsDiv">
        <h4>Already Bought</h4>
      </div>

    </div>

    <br>

    <div class="center">
    <a id="makeYourOwnBtn" class="waves-effect waves-light btn">Make your own Wishlist!</a>
      </div>

  </div>

  </div>

  <script src="./assets/all.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

  <script>


    document.addEventListener('click', event => {
      if (event.target.classList.contains('modal-trigger')) {
        // console.log('ping')
        let nextSibling = event.target.nextElementSibling
        console.log(nextSibling.textContent)
        nextSibling.classList.remove('hidden')
        document.addEventListener('click', event => {
          window.location.reload()
        })
      }
    })


    document.addEventListener('click', event => {
      if (event.target.classList.contains('cancel')){
        window.location.reload()
      }
    })




    document.addEventListener('DOMContentLoaded', function () {
      var elems = document.querySelectorAll('.sidenav');
      var instances = M.Sidenav.init(elems, {});
    })

    M.AutoInit();
    document.addEventListener('DOMContentLoaded', function () {
      var elems = document.querySelectorAll('select');
      var instances = M.FormSelect.init(elems, {});
    })

    let listId = window.location.pathname.substr(window.location.pathname.length - 10);

    let newListData
    let newID

    axios.get(`/api/list/${listId}`, {
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      }
    })
      .then(({ data }) => {

        newListData = data
        // console.log(newListData.id)
        newID = newListData.id
        // console.log(newListData, 'lists')
        document.getElementById('title').innerHTML =
          `<h2> ${data.title} </h2>
        by <h4> ${data.User.username} </h4>
        `
        document.title=`${data.User.username}'s wishlist`

        axios.get(`/api/items`, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        })
          .then(({ data }) => {


            data.forEach(item => {

              // console.log(newID)
              if (item.lid == newID) {

                if (item.isDone) {
                  document.getElementById('boughtItemsDiv').innerHTML += `
                <li data-description='${item.description}' class="collection-item black white-text"> ${item.description}
                <a class="truncate" data-link="${item.link}" target="_blank" href="${item.link}">${item.link}</a> 
                </li>
                `
                } else {

                  document.getElementById('myItemsDiv').innerHTML += `
                <li data-description='${item.description}' class="collection-item black white-text"> ${item.description}
                <a class="truncate" data-link="${item.link}" target="_blank" href="${item.link}">${item.link}</a> 
                <br>
                <i  class="material-icons green-text modal-trigger">check</i>
                <div class="myModal hidden">
                  <div class="modal-content black white-text">
                  Clicking this means that you have bought the item. Please click the checkmark below if you have bought this item! If not, press cancel or anywhere else on the page. 
                  <br>
                  <br>
                  <br>
                  <div class="center">
                  <i class="material-icons checkBtn green-text center" data-id='${item.id}'>check</i>
                  <br>
                  <br>
                  <i class="material-icons red-text center cancel">cancel</i>
                  </div>
                  </div>
                </div>
                </li>
                `

                }

              }
            }
            )
          })
      })

      .catch(err => console.log(err))


    document.addEventListener('click', event => {

      if (event.target.classList.contains('checkBtn')) {

        let upDatedItem = {
          description: event.target.dataset.description,
          link: event.target.dataset.link,
          isDone: true
        }
        axios.put(`/api/items/${event.target.dataset.id}`, upDatedItem, {

        })
          .then(res => {
            // console.log('updated')
            window.location.reload()

          })

      }
    })

    function displaySignOut() {

      localStorage.getItem('token')
      if (localStorage.getItem("token") === null) {
        const signOut2 = document.createElement('li')
        signOut2.innerHTML = `
      <li class="white-text" id="logInButtonMain"><a class="white-text" href="/login">Log In</a></li>
      `
        document.getElementById('signOutConditional').append(signOut2)
        document.getElementById('logInButtonMain').addEventListener('click', event => {
          window.location = '/login'
        })


      } else {

        const signOut1 = document.createElement('li')
        signOut1.innerHTML = `
      <li class="white-text" id="signOutMain"><a class="white-text" href="/login">Sign Out</a></li>
      `
        document.getElementById('signOutConditional').append(signOut1)
        document.getElementById('signOutMain').addEventListener('click', event => {
          localStorage.removeItem('token')
          window.location = '/login'
        })

      }
    }

    function displaySignOutNav() {

      localStorage.getItem('token')
      if (localStorage.getItem("token") === null) {
        const signOut2 = document.createElement('li')
        signOut2.innerHTML = `
      <li class="white-text" id="logInButtonNav"><a class="white-text" href="/login">Log In</a></li>
      `
        document.getElementById('signOutNav').append(signOut2)
        document.getElementById('logInButtonNav').addEventListener('click', event => {
          window.location = '/login'
        })
      } else {

        const signOut1 = document.createElement('li')
        signOut1.innerHTML = `
      <li  id="signOutButtonNav"><a class="white-text" href="/login">Sign Out</a></li>
      `
        document.getElementById('signOutNav').append(signOut1)
        document.getElementById('signOutButtonNav').addEventListener('click', event => {
          localStorage.removeItem('token')
          window.location = '/login'
        })
      }
    }


    displaySignOut()
    displaySignOutNav()


    document.getElementById('makeYourOwnBtn').addEventListener('click', event => {
      if(localStorage.getItem('token')){
        window.location='/home'
      } else {
        window.location='/register'
      }
    })


























  </script>

</body>

</html>